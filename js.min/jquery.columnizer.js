// version 1.6.0
// http://welcome.totheinter.net/columnizer-jquery-plugin/
// created by: Adam Wulf @adamwulf, adam.wulf@gmail.com

(function(e){e.fn.columnize=function(t){var n={width:400,columns:false,buildOnce:false,overflow:false,doneFunc:function(){},target:false,ignoreImageLoading:true,columnFloat:"left",lastNeverTallest:false,accuracy:false,manualBreaks:false,cssClassPrefix:""};t=e.extend(n,t);if(typeof t.width=="string"){t.width=parseInt(t.width,10);if(isNaN(t.width)){t.width=n.width}}return this.each(function(){function h(e,t){var n=t?".":"";if(f.length){return n+f+"-"+e}return n+e}function p(n,r,i,s){while((a||i.height()<s)&&r[0].childNodes.length){var o=r[0].childNodes[0];if(e(o).find(h("columnbreak",true)).length){return}if(e(o).hasClass(h("columnbreak"))){return}n.append(o)}if(n[0].childNodes.length===0)return;var u=n[0].childNodes;var f=u[u.length-1];n[0].removeChild(f);var l=e(f);if(l[0].nodeType==3){var c=l[0].nodeValue;var p=t.width/18;if(t.accuracy)p=t.accuracy;var d;var v=null;while(i.height()<s&&c.length){var m=c.indexOf(" ",p);if(m!=-1){d=c.substring(0,c.indexOf(" ",p))}else{d=c}v=document.createTextNode(d);n.append(v);if(c.length>p&&m!=-1){c=c.substring(m)}else{c=""}}if(i.height()>=s&&v!==null){n[0].removeChild(v);c=v.nodeValue+c}if(c.length){l[0].nodeValue=c}else{return false}}if(r.contents().length){r.prepend(l)}else{r.append(l)}return l[0].nodeType==3}function d(e,t,n,r){if(e.contents(":last").find(h("columnbreak",true)).length){return}if(e.contents(":last").hasClass(h("columnbreak"))){return}if(t.contents().length){var i=t.contents(":first");if(i.get(0).nodeType!=1)return;var s=i.clone(true);if(i.hasClass(h("columnbreak"))){e.append(s);i.remove()}else if(a){e.append(s);i.remove()}else if(s.get(0).nodeType==1&&!s.hasClass(h("dontend"))){e.append(s);if(s.is("img")&&n.height()<r+20){i.remove()}else if(!i.hasClass(h("dontsplit"))&&n.height()<r+20){i.remove()}else if(s.is("img")||i.hasClass(h("dontsplit"))){s.remove()}else{s.empty();if(!p(s,i,n,r)){i.addClass(h("split"));if(i.children().length){d(s,i,n,r)}}else{i.addClass(h("split"))}if(s.get(0).childNodes.length===0){s.remove()}}}}}function v(){if(r.data("columnized")&&r.children().length==1){return}r.data("columnized",true);r.data("columnizing",true);r.empty();r.append(e("<div class='"+h("first")+" "+h("last")+" "+h("column")+" "+"' style='width:100%; float: "+t.columnFloat+";'></div>"));$col=r.children().eq(r.children().length-1);$destroyable=s.clone(true);if(t.overflow){targetHeight=t.overflow.height;p($col,$destroyable,$col,targetHeight);if(!$destroyable.contents().find(":first-child").hasClass(h("dontend"))){d($col,$destroyable,$col,targetHeight)}while($col.contents(":last").length&&m($col.contents(":last").get(0))){var n=$col.contents(":last");n.remove();$destroyable.prepend(n)}var i="";var o=document.createElement("DIV");while($destroyable[0].childNodes.length>0){var u=$destroyable[0].childNodes[0];if(u.attributes){for(var a=0;a<u.attributes.length;a++){if(u.attributes[a].nodeName.indexOf("jQuery")===0){u.removeAttribute(u.attributes[a].nodeName)}}}o.innerHTML="";o.appendChild($destroyable[0].childNodes[0]);i+=o.innerHTML}var f=e(t.overflow.id)[0];f.innerHTML=i}else{$col.append($destroyable)}r.data("columnizing",false);if(t.overflow&&t.overflow.doneFunc){t.overflow.doneFunc()}}function m(t){if(t.nodeType==3){if(/^\s+$/.test(t.nodeValue)){if(!t.previousSibling)return false;return m(t.previousSibling)}return false}if(t.nodeType!=1)return false;if(e(t).hasClass(h("dontend")))return true;if(t.childNodes.length===0)return false;return m(t.childNodes[t.childNodes.length-1])}function g(){l=0;if(o==r.width())return;o=r.width();var n=Math.round(r.width()/t.width);var u=t.width;var f=t.height;if(t.columns)n=t.columns;if(a){n=s.find(h("columnbreak",true)).length+1;u=false}if(n<=1){return v()}if(r.data("columnizing"))return;r.data("columnized",true);r.data("columnizing",true);r.empty();r.append(e("<div style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"));x=r.children(":last");x.append(s.clone());i=x.height();r.empty();var c=i/n;var g=true;var y=3;var b=false;if(t.overflow){y=1;c=t.overflow.height}else if(f&&u){y=1;c=f;b=true}for(var w=0;w<y&&w<20;w++){r.empty();var E,S,x,T;try{E=s.clone(true)}catch(N){E=s.clone()}E.css("visibility","hidden");for(var C=0;C<n;C++){S=C===0?h("first"):"";S+=" "+h("column");S=C==n-1?h("last")+" "+S:S;r.append(e("<div class='"+S+"' style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"))}C=0;while(C<n-(t.overflow?0:1)||b&&E.contents().length){if(r.children().length<=C){r.append(e("<div class='"+S+"' style='width:"+Math.floor(100/n)+"%; float: "+t.columnFloat+";'></div>"))}x=r.children().eq(C);if(b){x.width(u+"px")}p(x,E,x,c);d(x,E,x,c);while(x.contents(":last").length&&m(x.contents(":last").get(0))){T=x.contents(":last");T.remove();E.prepend(T)}C++;if(x.contents().length===0&&E.contents().length){x.append(E.contents(":first"))}else if(C==n-(t.overflow?0:1)&&!t.overflow){if(E.find(h("columnbreak",true)).length){n++}}}if(t.overflow&&!b){var k=false;var L=document.all&&navigator.appVersion.indexOf("MSIE 7.")!=-1;if(k||L){var A="";var O=document.createElement("DIV");while(E[0].childNodes.length>0){var M=E[0].childNodes[0];for(C=0;C<M.attributes.length;C++){if(M.attributes[C].nodeName.indexOf("jQuery")===0){M.removeAttribute(M.attributes[C].nodeName)}}O.innerHTML="";O.appendChild(E[0].childNodes[0]);A+=O.innerHTML}var _=e(t.overflow.id)[0];_.innerHTML=A}else{e(t.overflow.id).empty().append(E.contents().clone(true))}}else if(!b){x=r.children().eq(r.children().length-1);E.contents().each(function(){x.append(e(this))});var D=x.height();var P=D-c;var H=0;var B=1e7;var j=0;var F=false;var I=0;r.children().each(function(e){return function(t){var n=e.children().eq(t);var r=n.children(":last").find(h("columnbreak",true)).length;if(!r){var i=n.height();F=false;H+=i;if(i>j){j=i;F=true}if(i<B)B=i;I++}}}(r));var q=H/I;if(H===0){w=y}else if(t.lastNeverTallest&&F){l+=30;c=c+30;if(w==y-1)y++}else if(j-B>30){c=q+30}else if(Math.abs(q-c)>20){c=q}else{w=y}}else{r.children().each(function(e){x=r.children().eq(e);x.width(u+"px");if(e===0){x.addClass(h("first"))}else if(e==r.children().length-1){x.addClass(h("last"))}else{x.removeClass(h("first"));x.removeClass(h("last"))}});r.width(r.children().length*u+"px")}r.append(e("<br style='clear:both;'>"))}r.find(h("column",true)).find(":first"+h("removeiffirst",true)).remove();r.find(h("column",true)).find(":last"+h("removeiflast",true)).remove();r.data("columnizing",false);if(t.overflow){t.overflow.doneFunc()}t.doneFunc()}var r=t.target?e(t.target):e(this);var i=e(this).height();var s=e("<div></div>");var o=0;var u=false;var a=t.manualBreaks;var f=n.cssClassPrefix;if(typeof t.cssClassPrefix=="string"){f=t.cssClassPrefix}var l=0;s.append(e(this).contents().clone(true));if(!t.ignoreImageLoading&&!t.target){if(!r.data("imageLoaded")){r.data("imageLoaded",true);if(e(this).find("img").length>0){var c=function(e,n){return function(){if(!e.data("firstImageLoaded")){e.data("firstImageLoaded","true");e.empty().append(n.children().clone(true));e.columnize(t)}}}(e(this),s);e(this).find("img").one("load",c);e(this).find("img").one("abort",c);return}}}r.empty();g();if(!t.buildOnce){e(window).resize(function(){if(!t.buildOnce){if(r.data("timeout")){clearTimeout(r.data("timeout"))}r.data("timeout",setTimeout(g,200))}})}})}})(jQuery)